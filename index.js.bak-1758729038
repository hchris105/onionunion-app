require('dotenv').config();
const express = require('express');
const axios = require('axios');
const fs = require('fs');
const path = require('path');
const MiniSearch = require('minisearch');

const app = express();
const PORT = process.env.PORT || 3000;
const CLAUDE_API_KEY = process.env.CLAUDE_API_KEY;

app.use(express.json({ limit: '2mb' }));
app.use(express.urlencoded({ extended: true }));
// 讓首頁與前端頁面可直接打開
app.use(express.static('public'));

// 讓前端用 prompt 也能通：如果有 prompt 但沒 question，就自動補成 question
app.use((req, res, next) => {
  if (req.body && typeof req.body.prompt === 'string' && !req.body.question) {
    req.body.question = req.body.prompt;
  }
  next();
});

// ---- 簡易 RAG：載入 PDF 轉出的文字片段（由 ingest 產生） ----
let chunks = [];
let mini;
function loadChunks() {
  try {
    const p = path.join(__dirname, 'data', 'chunks.json');
    if (fs.existsSync(p)) {
      chunks = JSON.parse(fs.readFileSync(p, 'utf8'));
      mini = new MiniSearch({
        fields: ['text'],
        storeFields: ['text', 'source'],
        searchOptions: { boost: { text: 2 }, prefix: true, fuzzy: 0.1 }
      });
      mini.addAll(chunks.map((t, i) => ({ id: i, ...t })));
      console.log(`Loaded ${chunks.length} chunks`);
    } else {
      console.log('No chunks.json yet. Please run ingest script.');
    }
  } catch (e) {
    console.error('loadChunks error:', e.message);
  }
}
loadChunks();

// 健康檢查
app.get('/', (req, res) => {
  res.send('OnionUnion API OK ✅ (Claude + PDF RAG)');
});

// 問答端點：接收使用者/對方資訊＋問題
app.post('/ask', async (req, res) => {
  try {
    if (!CLAUDE_API_KEY) return res.status(500).json({ error: 'CLAUDE_API_KEY not set' });

    const {
      myName, myBirth, myMother,
      otherName, otherBirth, otherMother,
      question, mode
    } = req.body || {};

    if (!question || typeof question !== 'string') {
      return res.status(400).json({ error: 'question is required' });
    }

    // 從知識庫擷取相關內容做為 context（取前 5 段）
    let context = '';
    if (mini) {
      const q = [question, myBirth, otherBirth, myName, otherName]
        .filter(Boolean).join(' ');
      const hits = mini.search(q).slice(0, 5);
      context = hits.map(h => `【來源:${h.source}】${h.text}`).join('\n---\n');
    }

    const system = `
你是「OnionUnion · 神秘學顧問」，語氣溫和、娛樂向；可用塔羅/占星等比喻說明，
但避免做醫療、法律或保證性結論。若引用知識庫，請嚴謹且簡短地說明依據。
請用段落與條列清楚回答，並給 1~3 條可行的行動建議。
`.trim();

    // 把使用者提供的欄位整理成提示
    const profile = `
我的姓名：${myName || '（未填）'}
我的生日：${myBirth || '（未填）'}
我的母親姓名：${myMother || '（未填）'}
${otherName || otherBirth || otherMother ? `
對方姓名：${otherName || '（未填）'}
對方生日：${otherBirth || '（未填）'}
對方母親姓名：${otherMother || '（未填）'}` : ''}`.trim();

    const userPrompt = `
[使用者資訊]
${profile}

[問題]
${question}

[模式] ${mode || 'general'}

[知識庫節錄]
${context || '（目前未找到相關節錄，請一般性回答）'}
`.trim();

    const r = await axios.post(
      'https://api.anthropic.com/v1/messages',
      {
        model: 'claude-3-5-sonnet-20240620',
        max_tokens: 700,
        system,
        messages: [{ role: 'user', content: userPrompt }]
      },
      {
        headers: {
          'x-api-key': CLAUDE_API_KEY,
          'anthropic-version': '2023-06-01',
          'content-type': 'application/json'
        },
        timeout: 60000
      }
    );

    const answer = r.data?.content?.[0]?.text || '…';
    res.json({ answer });
  } catch (err) {
    const detail = err.response?.data || err.message;
    console.error('Claude error:', detail);
    res.status(502).json({ error: 'claude_error', detail });
  }
});

app.listen(PORT, () => console.log(`Server listening on ${PORT}`));
